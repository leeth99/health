<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ë™ ê¸°ë¡ ì•±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // âš ï¸ ì—¬ê¸°ì— Firebase ì„¤ì • ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš” âš ï¸
        const firebaseConfig = {
            apiKey: "ì—¬ê¸°ì—_API_KEY_ì…ë ¥",
            authDomain: "ì—¬ê¸°ì—_AUTH_DOMAIN_ì…ë ¥",
            databaseURL: "ì—¬ê¸°ì—_DATABASE_URL_ì…ë ¥",
            projectId: "ì—¬ê¸°ì—_PROJECT_ID_ì…ë ¥",
            messagingSenderId: "ì—¬ê¸°ì—_MESSAGING_SENDER_ID_ì…ë ¥",
            appId: "ì—¬ê¸°ì—_APP_ID_ì…ë ¥"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ë©¤ë²„ ì •ë³´
        const members = [
            { id: 1, name: 'ë°±ì†Œì§„', color: 'bg-blue-500' },
            { id: 2, name: 'ì´ì›ë ¬', color: 'bg-pink-500' },
            { id: 3, name: 'ì´íƒœí˜•', color: 'bg-green-500' },
            { id: 4, name: 'ì§€í™ê·œ', color: 'bg-purple-500' }
        ];

        // ì „ì—­ ìƒíƒœ
        let exercises = [];
        let selectedMember = 1;
        let duration = '';
        let showAddForm = false;
        let showPhotos = false;
        let selectedMemberPhotos = null;
        let photo = null;
        let loading = false;

        // ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ë“¤
        function getWeekDates() {
            const today = new Date();
            const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            const week = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                week.push(date);
            }
            return week;
        }

        function getLastWeekDates() {
            const today = new Date();
            const lastWeekMonday = new Date(today.setDate(today.getDate() - today.getDay() - 6));
            const week = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(lastWeekMonday);
                date.setDate(lastWeekMonday.getDate() + i);
                week.push(date);
            }
            return week;
        }

        const weekDates = getWeekDates();
        const lastWeekDates = getLastWeekDates();

        // ìš´ë™ íšŸìˆ˜ ê³„ì‚°
        function getWeeklyCount(memberId) {
            const thisWeekStart = weekDates[0];
            const thisWeekEnd = new Date(weekDates[6]);
            thisWeekEnd.setHours(23, 59, 59);

            return exercises.filter(ex => 
                ex.memberId === memberId && 
                new Date(ex.date) >= thisWeekStart && 
                new Date(ex.date) <= thisWeekEnd
            ).length;
        }

        function getLastWeeklyCount(memberId) {
            const lastWeekStart = lastWeekDates[0];
            const lastWeekEnd = new Date(lastWeekDates[6]);
            lastWeekEnd.setHours(23, 59, 59);

            return exercises.filter(ex => 
                ex.memberId === memberId && 
                new Date(ex.date) >= lastWeekStart && 
                new Date(ex.date) <= lastWeekEnd
            ).length;
        }

        // ìš´ë™ ê¸°ë¡ ì¶”ê°€
        async function addExercise() {
            if (!duration || !photo) {
                alert('ìš´ë™ ì‹œê°„ê³¼ ì‚¬ì§„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            loading = true;
            render();

            try {
                const newExercise = {
                    memberId: selectedMember,
                    memberName: members.find(m => m.id === selectedMember)?.name,
                    date: new Date().toISOString(),
                    duration: parseInt(duration),
                    photoBase64: photo,
                    timestamp: Date.now()
                };

                const exercisesRef = ref(database, 'exercises');
                await push(exercisesRef, newExercise);

                // í¼ ì´ˆê¸°í™”
                duration = '';
                photo = null;
                selectedMember = 1;
                showAddForm = false;
                alert('ìš´ë™ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                render();
            } catch (error) {
                console.error('ìš´ë™ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ìš´ë™ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                loading = false;
                render();
            }
        }

        // ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ë¡œ í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    photo = e.target.result;
                    render();
                };
                reader.readAsDataURL(file);
            }
        }

        // ì…ë ¥ê°’ ë³€ê²½ ì²˜ë¦¬
        function handleMemberChange(value) {
            selectedMember = parseInt(value);
        }

        function handleDurationChange(value) {
            duration = value;
        }

        // ë©¤ë²„ë³„ ì‚¬ì§„ ë³´ê¸°
        function showMemberPhotos(memberId) {
            const memberExercises = exercises
                .filter(ex => ex.memberId === memberId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            selectedMemberPhotos = {
                memberId,
                memberName: members.find(m => m.id === memberId)?.name,
                exercises: memberExercises
            };
            showPhotos = true;
            render();
        }

        // ë‚ ì§œë³„ ê·¸ë£¹í™”
        function groupExercisesByDate(exercises) {
            const groups = {};
            exercises.forEach(exercise => {
                const date = new Date(exercise.date).toLocaleDateString();
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(exercise);
            });
            return groups;
        }

        // ë Œë”ë§ í•¨ìˆ˜
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="max-w-4xl mx-auto p-4">
                    <!-- í—¤ë” -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                                    ğŸ† ìš´ë™ ê¸°ë¡
                                </h1>
                                <p class="text-gray-600 mt-2">ì£¼ 4íšŒ ìš´ë™ ëª©í‘œ ë‹¬ì„±í•˜ê¸°! ğŸ’ª</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">ì´ë²ˆ ì£¼</div>
                                <div class="text-lg font-semibold text-indigo-600">
                                    ${weekDates[0].toLocaleDateString()} ~ ${weekDates[6].toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-sm text-gray-600">ğŸ”¥ Firebase ì—°ê²°ë¨ - ì™„ì „ ë¬´ë£Œ!</span>
                        </div>
                    </div>

                    <!-- ë©¤ë²„ë³„ ì§„í–‰ìƒí™© -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        ${members.map(member => {
                            const weeklyCount = getWeeklyCount(member.id);
                            const isCompleted = weeklyCount >= 4;
                            return `
                                <div class="${member.color} rounded-xl p-4 text-white shadow-lg cursor-pointer hover:shadow-xl hover:scale-105 transition-all"
                                     onclick="showMemberPhotos(${member.id})">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="font-bold text-lg">${member.name}</h3>
                                        <span class="text-2xl">${isCompleted ? 'âœ…' : 'ğŸ¯'}</span>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span>ì´ë²ˆ ì£¼ ìš´ë™</span>
                                            <span class="font-bold text-xl">${weeklyCount}/4</span>
                                        </div>
                                        <div class="w-full bg-white bg-opacity-30 rounded-full h-3">
                                            <div class="bg-white h-3 rounded-full transition-all duration-300"
                                                 style="width: ${Math.min((weeklyCount / 4) * 100, 100)}%"></div>
                                        </div>
                                        <div class="text-sm opacity-90">
                                            ${isCompleted ? 'ëª©í‘œ ë‹¬ì„±! ğŸ‰' : `${4 - weeklyCount}íšŒ ë‚¨ìŒ`}
                                        </div>
                                        <div class="text-xs opacity-75 mt-2 border-t border-white border-opacity-30 pt-2">
                                            ğŸ“¸ í´ë¦­í•˜ì—¬ ìš´ë™ ì‚¬ì§„ ë³´ê¸°
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- ìš´ë™ ì¶”ê°€ ë²„íŠ¼ -->
                    <div class="text-center mb-6">
                        <button onclick="toggleAddForm()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg transition-all hover:scale-105 flex items-center gap-3 mx-auto">
                            â• ìš´ë™ ê¸°ë¡ ì¶”ê°€
                        </button>
                    </div>

                    <!-- ìš´ë™ ì¶”ê°€ í¼ -->
                    ${showAddForm ? `
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                ğŸ“· ìš´ë™ ì¸ì¦í•˜ê¸°
                            </h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ìš´ë™í•œ ì‚¬ëŒ</label>
                                        <select onchange="handleMemberChange(this.value)"
                                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                            ${members.map(member => 
                                                `<option value="${member.id}" ${member.id === selectedMember ? 'selected' : ''}>
                                                    ${member.name}
                                                </option>`
                                            ).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ìš´ë™ ì‹œê°„ (ë¶„)</label>
                                        <input type="number" value="${duration}" oninput="handleDurationChange(this.value)" 
                                               placeholder="ì˜ˆ: 30" min="1" max="300"
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ëŸ¬ë‹ë¨¸ì‹  ì¸ì¦ ì‚¬ì§„ (5MB ì´í•˜)</label>
                                        <input type="file" accept="image/*" onchange="handlePhotoUpload(event)"
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ì´ë¯¸ì§€ëŠ” Base64ë¡œ ì €ì¥ë˜ì–´ ì™„ì „íˆ ë¬´ë£Œì…ë‹ˆë‹¤!</p>
                                    </div>
                                </div>

                                <div>
                                    ${photo ? `
                                        <div class="space-y-4">
                                            <label class="block text-sm font-medium text-gray-700">ë¯¸ë¦¬ë³´ê¸°</label>
                                            <img src="${photo}" alt="ìš´ë™ ì¸ì¦" 
                                                 class="w-full h-48 object-cover rounded-lg border border-gray-300 shadow-sm">
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="flex gap-3 mt-6">
                                <button onclick="addExercise()" ${loading ? 'disabled' : ''}
                                        class="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex-1">
                                    ${loading ? 'â³ ì €ì¥ ì¤‘...' : 'âœ… ì¸ì¦ ì™„ë£Œ'}
                                </button>
                                <button onclick="toggleAddForm()" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- ì €ë²ˆ ì£¼ ë¯¸ë‹¬ì„±ì -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            âŒ ì €ë²ˆ ì£¼ í• ë‹¹ëŸ‰ ë¯¸ë‹¬ì„±ì
                        </h2>
                        ${(() => {
                            const failedMembers = members.filter(member => getLastWeeklyCount(member.id) < 4);
                            
                            if (failedMembers.length === 0) {
                                return `
                                    <div class="text-center py-8 text-green-600">
                                        <div class="text-6xl mb-3">âœ…</div>
                                        <p class="font-semibold">ëª¨ë“  ë©¤ë²„ê°€ ì €ë²ˆ ì£¼ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ğŸ‰</p>
                                        <p class="text-sm text-gray-600 mt-1">
                                            ${lastWeekDates[0].toLocaleDateString()} ~ ${lastWeekDates[6].toLocaleDateString()}
                                        </p>
                                    </div>
                                `;
                            }

                            return `
                                <div class="space-y-3">
                                    <div class="text-sm text-gray-600 mb-4">
                                        ê¸°ê°„: ${lastWeekDates[0].toLocaleDateString()} ~ ${lastWeekDates[6].toLocaleDateString()}
                                    </div>
                                    ${failedMembers.map(member => {
                                        const lastWeekCount = getLastWeeklyCount(member.id);
                                        return `
                                            <div class="flex items-center gap-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                                <div class="w-4 h-4 rounded-full ${member.color}"></div>
                                                <div class="flex-1">
                                                    <div class="font-semibold text-gray-800">${member.name}</div>
                                                    <div class="text-sm text-red-600">
                                                        ${lastWeekCount}/4íšŒ ì™„ë£Œ â€¢ ${4 - lastWeekCount}íšŒ ë¯¸ë‹¬ì„±
                                                    </div>
                                                </div>
                                                <span class="text-red-500 text-xl">âŒ</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        })()}
                    </div>
                </div>

                <!-- ì‚¬ì§„ ëª¨ë‹¬ -->
                ${showPhotos && selectedMemberPhotos ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closePhotos(event)">
                        <div class="bg-white rounded-xl w-full max-w-4xl max-h-screen overflow-hidden flex flex-col" onclick="event.stopPropagation()">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-2xl font-bold text-gray-800">
                                        ğŸ“· ${selectedMemberPhotos.memberName}ì˜ ìš´ë™ ê¸°ë¡
                                    </h2>
                                    <button onclick="closePhotos()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">Ã—</button>
                                </div>
                                <p class="text-gray-600 mt-1">ì´ ${selectedMemberPhotos.exercises.length}ê°œì˜ ìš´ë™ ê¸°ë¡ ğŸ“Š</p>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-6">
                                ${selectedMemberPhotos.exercises.length === 0 ? `
                                    <div class="text-center py-12 text-gray-500">
                                        <div class="text-6xl mb-4">ğŸ“·</div>
                                        <p class="text-lg font-medium">ì•„ì§ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                        <p class="text-sm">ì²« ë²ˆì§¸ ìš´ë™ì„ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ’ª</p>
                                    </div>
                                ` : `
                                    <div class="space-y-6">
                                        ${Object.entries(groupExercisesByDate(selectedMemberPhotos.exercises)).map(([date, dayExercises]) => `
                                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                                    <h3 class="font-semibold text-gray-800">
                                                        ğŸ“… ${date} (${dayExercises.length}íšŒ ìš´ë™)
                                                    </h3>
                                                </div>
                                                <div class="p-4">
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        ${dayExercises.map(exercise => `
                                                            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                                                                <img src="${exercise.photoBase64}" 
                                                                     alt="${exercise.memberName} ìš´ë™ ì¸ì¦"
                                                                     class="w-full h-48 object-cover">
                                                                <div class="p-3">
                                                                    <div class="flex justify-between items-center">
                                                                        <span class="text-sm font-medium text-gray-800">
                                                                            ğŸ’ª ${exercise.duration}ë¶„ ìš´ë™
                                                                        </span>
                                                                        <span class="text-xs text-gray-500">
                                                                            ${new Date(exercise.date).toLocaleTimeString()}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <div class="p-4 border-t border-gray-200 bg-gray-50">
                                <button onclick="closePhotos()" 
                                        class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-semibold">
                                    ë‹«ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        window.toggleAddForm = () => {
            showAddForm = !showAddForm;
            // í¼ì„ ì—´ ë•Œë§ˆë‹¤ ì´ˆê¸°í™”
            if (showAddForm) {
                selectedMember = 1;
                duration = '';
                photo = null;
            }
            render();
        };

        window.addExercise = addExercise;
        window.handlePhotoUpload = handlePhotoUpload;
        window.handleMemberChange = handleMemberChange;
        window.handleDurationChange = handleDurationChange;
        window.showMemberPhotos = showMemberPhotos;
        
        window.closePhotos = (event) => {
            if (event && event.target !== event.currentTarget) return;
            showPhotos = false;
            selectedMemberPhotos = null;
            render();
        };

        // Firebase ì‹¤ì‹œê°„ ë°ì´í„° êµ¬ë…
        const exercisesRef = ref(database, 'exercises');
        onValue(exercisesRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                exercises = Object.keys(data).map(key => ({
                    firebaseId: key,
                    ...data[key]
                }));
            } else {
                exercises = [];
            }
            render();
        });

        // ì´ˆê¸° ë Œë”ë§
        render();
    </script>
</body>
</html>
