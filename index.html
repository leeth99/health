<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운동 기록 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 추가 스타일 */
        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ⚠️ 여기에 Firebase 설정 정보를 입력하세요 ⚠️
        const firebaseConfig = {
            apiKey: "여기에_API_KEY_입력",
            authDomain: "여기에_AUTH_DOMAIN_입력",
            databaseURL: "여기에_DATABASE_URL_입력",
            projectId: "여기에_PROJECT_ID_입력",
            messagingSenderId: "여기에_MESSAGING_SENDER_ID_입력",
            appId: "여기에_APP_ID_입력"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 멤버 정보
        const members = [
            { id: 1, name: '백소진', color: 'bg-blue-500' },
            { id: 2, name: '이원렬', color: 'bg-pink-500' },
            { id: 3, name: '이태형', color: 'bg-green-500' },
            { id: 4, name: '지홍규', color: 'bg-purple-500' }
        ];

        // 전역 상태
        let exercises = [];
        let selectedMember = 1;
        let duration = '';
        let showAddForm = false;
        let showPhotos = false;
        let selectedMemberPhotos = null;
        let photo = null;
        let loading = false;

        // 날짜 계산 함수들
        function getWeekDates() {
            const today = new Date();
            const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            const week = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                week.push(date);
            }
            return week;
        }

        function getLastWeekDates() {
            const today = new Date();
            const lastWeekMonday = new Date(today.setDate(today.getDate() - today.getDay() - 6));
            const week = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(lastWeekMonday);
                date.setDate(lastWeekMonday.getDate() + i);
                week.push(date);
            }
            return week;
        }

        const weekDates = getWeekDates();
        const lastWeekDates = getLastWeekDates();

        // 운동 횟수 계산
        function getWeeklyCount(memberId) {
            const thisWeekStart = weekDates[0];
            const thisWeekEnd = new Date(weekDates[6]);
            thisWeekEnd.setHours(23, 59, 59);

            return exercises.filter(ex => 
                ex.memberId === memberId && 
                new Date(ex.date) >= thisWeekStart && 
                new Date(ex.date) <= thisWeekEnd
            ).length;
        }

        function getLastWeeklyCount(memberId) {
            const lastWeekStart = lastWeekDates[0];
            const lastWeekEnd = new Date(lastWeekDates[6]);
            lastWeekEnd.setHours(23, 59, 59);

            return exercises.filter(ex => 
                ex.memberId === memberId && 
                new Date(ex.date) >= lastWeekStart && 
                new Date(ex.date) <= lastWeekEnd
            ).length;
        }

        // 운동 기록 추가
        async function addExercise() {
            if (!duration || !photo) {
                alert('운동 시간과 사진을 모두 입력해주세요.');
                return;
            }

            loading = true;
            render();

            try {
                const newExercise = {
                    memberId: selectedMember,
                    memberName: members.find(m => m.id === selectedMember)?.name,
                    date: new Date().toISOString(),
                    duration: parseInt(duration),
                    photoBase64: photo,
                    timestamp: Date.now()
                };

                const exercisesRef = ref(database, 'exercises');
                await push(exercisesRef, newExercise);

                // 폼 초기화
                duration = '';
                photo = null;
                selectedMember = 1;
                showAddForm = false;
                alert('운동 기록이 성공적으로 저장되었습니다! 🎉');
                render();
            } catch (error) {
                console.error('운동 기록 저장 실패:', error);
                alert('운동 기록 저장에 실패했습니다. 다시 시도해주세요.');
            } finally {
                loading = false;
                render();
            }
        }

        // 사진 업로드 처리
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('파일 크기는 5MB 이하로 해주세요.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    photo = e.target.result;
                    render();
                };
                reader.readAsDataURL(file);
            }
        }

        // 입력값 변경 처리
        function handleMemberChange(value) {
            selectedMember = parseInt(value);
        }

        function handleDurationChange(value) {
            duration = value;
        }

        // 멤버별 사진 보기
        function showMemberPhotos(memberId) {
            const memberExercises = exercises
                .filter(ex => ex.memberId === memberId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            selectedMemberPhotos = {
                memberId,
                memberName: members.find(m => m.id === memberId)?.name,
                exercises: memberExercises
            };
            showPhotos = true;
            render();
        }

        // 날짜별 그룹화
        function groupExercisesByDate(exercises) {
            const groups = {};
            exercises.forEach(exercise => {
                const date = new Date(exercise.date).toLocaleDateString();
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(exercise);
            });
            return groups;
        }

        // 렌더링 함수
        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="max-w-4xl mx-auto p-4">
                    <!-- 헤더 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                                    🏆 운동 기록
                                </h1>
                                <p class="text-gray-600 mt-2">주 4회 운동 목표 달성하기! 💪</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">이번 주</div>
                                <div class="text-lg font-semibold text-indigo-600">
                                    ${weekDates[0].toLocaleDateString()} ~ ${weekDates[6].toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-sm text-gray-600">🔥 Firebase 연결됨 - 완전 무료!</span>
                        </div>
                    </div>

                    <!-- 멤버별 진행상황 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        ${members.map(member => {
                            const weeklyCount = getWeeklyCount(member.id);
                            const isCompleted = weeklyCount >= 4;
                            return `
                                <div class="${member.color} rounded-xl p-4 text-white shadow-lg cursor-pointer hover:shadow-xl hover:scale-105 transition-all"
                                     onclick="showMemberPhotos(${member.id})">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="font-bold text-lg">${member.name}</h3>
                                        <span class="text-2xl">${isCompleted ? '✅' : '🎯'}</span>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span>이번 주 운동</span>
                                            <span class="font-bold text-xl">${weeklyCount}/4</span>
                                        </div>
                                        <div class="w-full bg-white bg-opacity-30 rounded-full h-3">
                                            <div class="bg-white h-3 rounded-full transition-all duration-300"
                                                 style="width: ${Math.min((weeklyCount / 4) * 100, 100)}%"></div>
                                        </div>
                                        <div class="text-sm opacity-90">
                                            ${isCompleted ? '목표 달성! 🎉' : `${4 - weeklyCount}회 남음`}
                                        </div>
                                        <div class="text-xs opacity-75 mt-2 border-t border-white border-opacity-30 pt-2">
                                            📸 클릭하여 운동 사진 보기
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- 운동 추가 버튼 -->
                    <div class="text-center mb-6">
                        <button onclick="toggleAddForm()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg transition-all hover:scale-105 flex items-center gap-3 mx-auto">
                            ➕ 운동 기록 추가
                        </button>
                    </div>

                    <!-- 운동 추가 폼 -->
                    ${showAddForm ? `
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                📷 운동 인증하기
                            </h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">운동한 사람</label>
                                        <select onchange="handleMemberChange(this.value)"
                                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                            ${members.map(member => 
                                                `<option value="${member.id}" ${member.id === selectedMember ? 'selected' : ''}>
                                                    ${member.name}
                                                </option>`
                                            ).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">운동 시간 (분)</label>
                                        <input type="number" value="${duration}" oninput="handleDurationChange(this.value)" 
                                               placeholder="예: 30" min="1" max="300"
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">러닝머신 인증 사진 (5MB 이하)</label>
                                        <input type="file" accept="image/*" onchange="handlePhotoUpload(event)"
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <p class="text-xs text-gray-500 mt-1">💡 이미지는 Base64로 저장되어 완전히 무료입니다!</p>
                                    </div>
                                </div>

                                <div>
                                    ${photo ? `
                                        <div class="space-y-4">
                                            <label class="block text-sm font-medium text-gray-700">미리보기</label>
                                            <img src="${photo}" alt="운동 인증" 
                                                 class="w-full h-48 object-cover rounded-lg border border-gray-300 shadow-sm">
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="flex gap-3 mt-6">
                                <button onclick="addExercise()" ${loading ? 'disabled' : ''}
                                        class="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex-1">
                                    ${loading ? '⏳ 저장 중...' : '✅ 인증 완료'}
                                </button>
                                <button onclick="toggleAddForm()" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                    취소
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- 저번 주 미달성자 -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            ❌ 저번 주 할당량 미달성자
                        </h2>
                        ${(() => {
                            const failedMembers = members.filter(member => getLastWeeklyCount(member.id) < 4);
                            
                            if (failedMembers.length === 0) {
                                return `
                                    <div class="text-center py-8 text-green-600">
                                        <div class="text-6xl mb-3">✅</div>
                                        <p class="font-semibold">모든 멤버가 저번 주 목표를 달성했습니다! 🎉</p>
                                        <p class="text-sm text-gray-600 mt-1">
                                            ${lastWeekDates[0].toLocaleDateString()} ~ ${lastWeekDates[6].toLocaleDateString()}
                                        </p>
                                    </div>
                                `;
                            }

                            return `
                                <div class="space-y-3">
                                    <div class="text-sm text-gray-600 mb-4">
                                        기간: ${lastWeekDates[0].toLocaleDateString()} ~ ${lastWeekDates[6].toLocaleDateString()}
                                    </div>
                                    ${failedMembers.map(member => {
                                        const lastWeekCount = getLastWeeklyCount(member.id);
                                        return `
                                            <div class="flex items-center gap-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                                <div class="w-4 h-4 rounded-full ${member.color}"></div>
                                                <div class="flex-1">
                                                    <div class="font-semibold text-gray-800">${member.name}</div>
                                                    <div class="text-sm text-red-600">
                                                        ${lastWeekCount}/4회 완료 • ${4 - lastWeekCount}회 미달성
                                                    </div>
                                                </div>
                                                <span class="text-red-500 text-xl">❌</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        })()}
                    </div>
                </div>

                <!-- 사진 모달 -->
                ${showPhotos && selectedMemberPhotos ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closePhotos(event)">
                        <div class="bg-white rounded-xl w-full max-w-4xl max-h-screen overflow-hidden flex flex-col" onclick="event.stopPropagation()">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-2xl font-bold text-gray-800">
                                        📷 ${selectedMemberPhotos.memberName}의 운동 기록
                                    </h2>
                                    <button onclick="closePhotos()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
                                </div>
                                <p class="text-gray-600 mt-1">총 ${selectedMemberPhotos.exercises.length}개의 운동 기록 📊</p>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-6">
                                ${selectedMemberPhotos.exercises.length === 0 ? `
                                    <div class="text-center py-12 text-gray-500">
                                        <div class="text-6xl mb-4">📷</div>
                                        <p class="text-lg font-medium">아직 운동 기록이 없습니다</p>
                                        <p class="text-sm">첫 번째 운동을 시작해보세요! 💪</p>
                                    </div>
                                ` : `
                                    <div class="space-y-6">
                                        ${Object.entries(groupExercisesByDate(selectedMemberPhotos.exercises)).map(([date, dayExercises]) => `
                                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                                    <h3 class="font-semibold text-gray-800">
                                                        📅 ${date} (${dayExercises.length}회 운동)
                                                    </h3>
                                                </div>
                                                <div class="p-4">
                                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        ${dayExercises.map(exercise => `
                                                            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                                                                <img src="${exercise.photoBase64}" 
                                                                     alt="${exercise.memberName} 운동 인증"
                                                                     class="w-full h-48 object-cover">
                                                                <div class="p-3">
                                                                    <div class="flex justify-between items-center">
                                                                        <span class="text-sm font-medium text-gray-800">
                                                                            💪 ${exercise.duration}분 운동
                                                                        </span>
                                                                        <span class="text-xs text-gray-500">
                                                                            ${new Date(exercise.date).toLocaleTimeString()}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <div class="p-4 border-t border-gray-200 bg-gray-50">
                                <button onclick="closePhotos()" 
                                        class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg font-semibold">
                                    닫기
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // 전역 함수들
        window.toggleAddForm = () => {
            showAddForm = !showAddForm;
            // 폼을 열 때마다 초기화
            if (showAddForm) {
                selectedMember = 1;
                duration = '';
                photo = null;
            }
            render();
        };

        window.addExercise = addExercise;
        window.handlePhotoUpload = handlePhotoUpload;
        window.handleMemberChange = handleMemberChange;
        window.handleDurationChange = handleDurationChange;
        window.showMemberPhotos = showMemberPhotos;
        
        window.closePhotos = (event) => {
            if (event && event.target !== event.currentTarget) return;
            showPhotos = false;
            selectedMemberPhotos = null;
            render();
        };

        // Firebase 실시간 데이터 구독
        const exercisesRef = ref(database, 'exercises');
        onValue(exercisesRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                exercises = Object.keys(data).map(key => ({
                    firebaseId: key,
                    ...data[key]
                }));
            } else {
                exercises = [];
            }
            render();
        });

        // 초기 렌더링
        render();
    </script>
</body>
</html>
